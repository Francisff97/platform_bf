# -----------------------------------------
# Laravel + Long Cache + (opt) WebP + (opt) CSP
# -----------------------------------------

<IfModule mod_rewrite.c>
  <IfModule mod_negotiation.c>
    Options -MultiViews -Indexes
  </IfModule>

  RewriteEngine On

  # --- (opt) Serve .webp quando esiste e il browser lo supporta ---
  RewriteCond %{REQUEST_FILENAME} \.(?:jpe?g|png)$ [NC]
  RewriteCond %{REQUEST_FILENAME}.webp -f
  RewriteCond %{HTTP_ACCEPT} image/webp
  RewriteRule ^ %{REQUEST_URI}.webp [T=image/webp,E=serve_webp:1]
  <IfModule mod_headers.c>
    Header append Vary Accept env=serve_webp
    Header set X-Served-WebP "true" env=serve_webp
  </IfModule>
  # ----------------------------------------------------------------

  # Authorization / XSRF forwarding (utile per API/Sanctum)
  RewriteCond %{HTTP:Authorization} .
  RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
  RewriteCond %{HTTP:x-xsrf-token} .
  RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

  # Trailing slash -> no slash (se non è dir fisica)
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} (.+)/$
  RewriteRule ^ %1 [L,R=301]

  # Front controller (se non è file/dir fisico)
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteRule ^ index.php [L]
</IfModule>

# -------------- Cache rules --------------

# Flag per asset statici
SetEnvIfNoCase Request_URI "\.(?:avif|webp|png|jpe?g|gif|svg|ico)$" long_cache=1
SetEnvIfNoCase Request_URI "\.(?:css|js)$"                            long_cache=1
SetEnvIfNoCase Request_URI "\.(?:woff2?|ttf|otf|eot)$"                long_cache=1
SetEnvIfNoCase Request_URI "^/storage/"                               long_cache=1

# Fingerprinted di Vite (hash nel nome) -> immutable
SetEnvIfNoCase Request_URI "^/build/.*\.(?:css|js)$"                  immutable=1

# Considera dinamico l’output PHP/HTML
<FilesMatch "\.php$">
  SetEnv dynamic 1
</FilesMatch>

<IfModule mod_headers.c>
  # Immutable per /build/*
  Header always set Cache-Control "public, max-age=31536000, immutable" env=immutable
  # 1 anno per altri asset statici
  Header always set Cache-Control "public, max-age=31536000" env=long_cache
  # No cache per contenuto dinamico e per errori
  Header always set Cache-Control "no-cache, no-store, must-revalidate" env=dynamic
  Header always set Cache-Control "no-cache, no-store, must-revalidate" "expr=%{REQUEST_STATUS} >= 400"
</IfModule>

<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/avif  "access plus 1 year"
  ExpiresByType image/webp  "access plus 1 year"
  ExpiresByType image/png   "access plus 1 year"
  ExpiresByType image/jpeg  "access plus 1 year"
  ExpiresByType image/gif   "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  ExpiresByType text/css    "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript        "access plus 1 year"
  ExpiresByType font/woff2  "access plus 1 year"
  ExpiresByType font/woff   "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  ExpiresByType application/font-woff  "access plus 1 year"
  ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
  ExpiresByType font/ttf    "access plus 1 year"
  ExpiresByType font/otf    "access plus 1 year"
  ExpiresByType text/html   "access plus 0 seconds"
</IfModule>

# -------------- (opt) Content-Security-Policy --------------
# L’errore “Content security policy – data” lo risolvi permettendo data: in img/font.
# Se vuoi attivarla lato Apache, togli il commento al blocco seguente.

#<IfModule mod_headers.c>
#  Header set Content-Security-Policy "
#    default-src 'self';
#    img-src 'self' data: https: blob:;
#    font-src 'self' https: data:;
#    style-src 'self' 'unsafe-inline' https:;
#    script-src 'self' 'unsafe-inline' https: https://www.googletagmanager.com https://www.gstatic.com https://embeds.iubenda.com https://cdn.iubenda.com https://unpkg.com https://www.youtube.com;
#    connect-src 'self' https:;
#    frame-src https://www.youtube.com https://www.youtube-nocookie.com;
#    object-src 'none';
#    base-uri 'self';
#    upgrade-insecure-requests
#  "
#</IfModule>