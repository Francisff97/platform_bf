# ----------------------------------------------------------------------
# Basic hardening
# ----------------------------------------------------------------------
<IfModule mod_headers.c>
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-XSS-Protection "1; mode=block"

  # CSP analoga a NGINX
  Header always set Content-Security-Policy "default-src 'self'; img-src 'self' data: blob: https:; font-src 'self' data: https:; media-src 'self' https:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: https://www.googletagmanager.com; connect-src 'self' https: https://embeds.iubenda.com https://cdn.iubenda.com https://www.youtube.com https://www.youtube-nocookie.com https://fonts.googleapis.com https://fonts.gstatic.com https://unpkg.com https://i.ytimg.com https://img.youtube.com; frame-src 'self' https://www.youtube.com https://www.youtube-nocookie.com; object-src 'none'; base-uri 'self'; upgrade-insecure-requests"
</IfModule>

# ----------------------------------------------------------------------
# Long cache (Expires + Cache-Control)
# ----------------------------------------------------------------------
<IfModule mod_expires.c>
  ExpiresActive On

  # HTML: no-cache
  ExpiresByType text/html "access"
  <FilesMatch "\.(html)$">
    <IfModule mod_headers.c>
      Header always set Cache-Control "no-cache, no-store, must-revalidate"
    </IfModule>
  </FilesMatch>

  # Vite build versionato -> immutable
  <IfModule mod_headers.c>
    <LocationMatch "^/build/">
      Header always set Cache-Control "public, max-age=31536000, immutable"
    </LocationMatch>
  </IfModule>

  # Immagini
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png  "access plus 1 year"
  ExpiresByType image/gif  "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"

  # CSS/JS
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType application/x-javascript "access plus 1 year"

  # Font
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff  "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
</IfModule>

# Fissa anche Cache-Control generico per statici (se Expires non scatta)
<IfModule mod_headers.c>
  <FilesMatch "\.(?:avif|webp|png|jpe?g|gif|ico|svg|css|js|mjs|woff2?|ttf|otf|eot)$">
    Header always set Cache-Control "public, max-age=31536000"
  </FilesMatch>
</IfModule>

# ----------------------------------------------------------------------
# (Opzionale) Serve .webp se esiste e browser lo accetta
# ----------------------------------------------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{REQUEST_FILENAME} \.(png|jpe?g)$ [NC]
  RewriteCond %{REQUEST_FILENAME}.webp -f
  RewriteCond %{HTTP_ACCEPT} image/webp
  RewriteRule ^(.+)\.(png|jpe?g)$ $1.$2.webp [T=image/webp,E=accept:1]
</IfModule>

# ----------------------------------------------------------------------
# Laravel front controller (come avevi)
# ----------------------------------------------------------------------
<IfModule mod_rewrite.c>
  <IfModule mod_negotiation.c>
    Options -MultiViews -Indexes
  </IfModule>

  RewriteEngine On

  # Handle Authorization Header
  RewriteCond %{HTTP:Authorization} .
  RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

  # Handle X-XSRF-Token Header
  RewriteCond %{HTTP:x-xsrf-token} .
  RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

  # Redirect Trailing Slashes If Not A Folder...
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_URI} (.+)/$
  RewriteRule ^ %1 [L,R=301]

  # Send Requests To Front Controller...
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteRule ^ index.php [L]
</IfModule>